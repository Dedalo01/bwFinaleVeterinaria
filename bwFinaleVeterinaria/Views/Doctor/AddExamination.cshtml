@model bwFinaleVeterinaria.Models.Examination

@{
    ViewBag.Title = "AddExamination";
}

<h2>Aggiungi Visita</h2>

@if (TempData["Success"] != null)
{
    <div class="my-5 alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Fail"] != null)
{
    <div class="my-5 alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Fail"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@using (Html.BeginForm("AddExamination", "Doctor", FormMethod.Post, new { @class = "form" }))
{
    @Html.AntiForgeryToken()

    <div class="form-group">
        @Html.Label("petId", "Seleziona animale", new { @class = "control-label" })
        <select name="petId" id="petId" class="form-control">
            <option value="-1">--- Seleziona Animale ---</option>
            @if (TempData["Pets"] != null)
            {
                foreach (var pet in TempData["Pets"] as List<bwFinaleVeterinaria.Models.Pet>)
                {
                    <option value="@pet.Id">@pet.Name | @pet.Microchip</option>
                }
            }
        </select>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.ExaminationDate, htmlAttributes: new { @class = "control-label" })
        @Html.EditorFor(model => model.ExaminationDate, new { htmlAttributes = new { @class = "form-control", type = "date" } })
        @Html.ValidationMessageFor(model => model.ExaminationDate, "", new { @class = "text-danger" })
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.ObjectiveExamimation, htmlAttributes: new { @class = "control-label" })
        @Html.EditorFor(model => model.ObjectiveExamimation, new { htmlAttributes = new { @class = "form-control" } })
        @Html.ValidationMessageFor(model => model.ObjectiveExamimation, "", new { @class = "text-danger" })
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.TreatmentDescription, htmlAttributes: new { @class = "control-label" })
        @Html.EditorFor(model => model.TreatmentDescription, new { htmlAttributes = new { @class = "form-control" } })
        @Html.ValidationMessageFor(model => model.TreatmentDescription, "", new { @class = "text-danger" })
    </div>

    <div class="form-group mt-3">
        <input type="submit" value="Aggiungi visita" class="btn btn-primary me-2" />
        <a href="@Url.Action("Index", "Doctor")" class="btn btn-secondary">Torna Indietro</a>
    </div>
}

<!-- Blocco per le chiamate asincorne -->
<div id="animalHistoryContainer" class="mt-3" style="display: none;"></div>

@section scripts {
    <script>
        $(function () {
            $('#petId').change(function () {
                var selectedPetId = $(this).val();
                if (selectedPetId != "-1") {
                    $.ajax({
                        url: '@Url.Action("GetAnimalHistory", "Doctor")',
                        type: 'GET',
                        data: { petId: selectedPetId },
                        success: function (result) {
                            $('#animalHistoryContainer').html(result);
                            $('#animalHistoryContainer').show();
                        },
                        error: function (xhr, status, error) {
                            console.error(xhr.responseText);
                        }
                    });
                }
                else {
                    $('#animalHistoryContainer').html('');
                    $('#animalHistoryContainer').hide();
                }
            });
        });
    </script>
}